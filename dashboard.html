<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediSys Patient Monitoring Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
        }

        .header p {
            color: #7f8c8d;
            text-align: center;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .active {
            color: #27ae60;
        }

        .warning {
            color: #f39c12;
        }

        .critical {
            color: #e74c3c;
        }

        .info {
            color: #3498db;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .warning-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .warning-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .high-priority {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .medium-priority {
            background: linear-gradient(135deg, #feca57, #ff9ff3);
            color: white;
        }

        .low-priority {
            background: linear-gradient(135deg, #48dbfb, #0abde3);
            color: white;
        }

        .warning-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5em;
        }

        .warning-content {
            flex: 1;
        }

        .warning-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .warning-desc {
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .warning-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-danger {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .btn-warning {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .btn-info {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .btn-small:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .status-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .status-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .status-icon {
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .status-label {
            font-size: 0.8em;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .status-value {
            font-weight: bold;
            font-size: 0.9em;
        }

        .status-value.online {
            color: #27ae60;
        }

        .status-value.warning {
            color: #f39c12;
        }

        .status-value.offline {
            color: #e74c3c;
        }

        .chart-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }

        .alerts-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }

        .alert-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .alert-critical {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .alert-warning {
            background: linear-gradient(135deg, #feca57, #ff9ff3);
            color: white;
        }

        .alert-info {
            background: linear-gradient(135deg, #48dbfb, #0abde3);
            color: white;
        }

        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.2em;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .alert-time {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .patients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .patient-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .patient-card:hover {
            transform: translateY(-3px);
        }

        .patient-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .patient-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }

        .patient-info h3 {
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .patient-status {
            font-size: 0.9em;
            padding: 3px 8px;
            border-radius: 15px;
            font-weight: bold;
        }

        .status-stable {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-critical {
            background: #f8d7da;
            color: #721c24;
        }

        .vital-signs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .vital-item {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.05);
        }

        .vital-value {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .vital-label {
            font-size: 0.8em;
            color: #7f8c8d;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .simulation-status {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .live-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        #addPatientModal input:focus,
        #addPatientModal select:focus {
            border-color: #667eea;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.6);
            outline: none;
        }

        #addPatientModal button#closeAddPatientBtn:hover {
            color: #667eea;
        }

        #addPatientModal button.btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(102, 126, 234, 0.6);
            cursor: pointer;
        }

        #openAddPatientBtn {
            background: linear-gradient(135deg, #764ba2, #667eea);
            color: #fff;
            border: none;
            padding: 14px 28px;
            font-weight: 700;
            font-size: 1.1em;
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(118, 75, 162, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            letter-spacing: 1.2px;
        }

        #openAddPatientBtn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(118, 75, 162, 0.7);
        }

        #openAddPatientBtn {
            background: linear-gradient(135deg, #5a4ba0, #5365e8);
            color: white;
            border: none;
            padding: 14px 28px;
            font-weight: 700;
            font-size: 1.1em;
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(83, 101, 232, 0.6);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            letter-spacing: 1.2px;
        }

        #openAddPatientBtn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(83, 101, 232, 0.8);
        }

        #patientModal {
            display: none;
            /* default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            /* display flex will be activated by JS */
        }

        #closeModalBtn {
            /* outline: 2px solid red !important; */
            /* background: rgba(255, 0, 0, 0.2) !important; */
            position: relative;
            z-index: 1500;
            /* higher than modal backdrop */
        }


        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🏥 MediSys Patient Monitoring</h1>
            <p>Real-time health telemetry dashboard for remote patient care</p>
        </div>

        <div class="simulation-status">
            <span class="live-indicator"></span>
            <strong>Live Simulation Active</strong> - Real-time data streaming from wearable devices
        </div>

        <div class="controls">
            <!-- <button class="btn btn-primary" onclick="startSimulation()">▶️ Start Monitoring</button>
            <button class="btn btn-secondary" onclick="stopSimulation()">⏸️ Pause Monitoring</button>
            <button class="btn btn-primary" onclick="triggerAlert()">🚨 Test Alert</button>
            <button class="btn btn-secondary" onclick="exportData()">📊 Export Data</button> -->
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value active" id="activePatients">0</div>
                <div class="stat-label">Active Patients</div>
            </div>

            <div class="stat-card">
                <div class="stat-value info" id="dataPoints">0</div>
                <div class="stat-label">Data Points/Hour</div>
            </div>
        </div>

        <div class="alerts-section">
            <h3 class="chart-title">🚨 Recent Critical Alerts</h3>
            <div id="alertsContainer">
                <div class="alert-item alert-critical">
                    <div class="alert-icon">💓</div>
                    <div class="alert-content">
                        <div class="alert-title">Critical: Heart Rate Anomaly</div>
                        <div class="alert-time">Patient Johnson - HR: 145 BPM - 2 min ago</div>
                    </div>
                </div>
                <div class="alert-item alert-warning">
                    <div class="alert-icon">🫁</div>
                    <div class="alert-content">
                        <div class="alert-title">Warning: Low Oxygen Saturation</div>
                        <div class="alert-time">Patient Smith - SpO2: 89% - 7 min ago</div>
                    </div>
                </div>
                <div class="alert-item alert-info">
                    <div class="alert-icon">🚶</div>
                    <div class="alert-content">
                        <div class="alert-title">Info: Prolonged Inactivity</div>
                        <div class="alert-time">Patient Williams - 4 hours - 15 min ago</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient Details Modal -->
        <div id="patientModal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div
                style="background: white; border-radius: 15px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 20px; position: relative;">
                <button id="closeModalBtn"
                    style="position: absolute; top: 10px; right: 15px; font-size: 24px; background: none; border: none; cursor: pointer;">&times;</button>
                <h2 id="modalPatientName">Patient Name</h2>

                <div style="margin-bottom: 15px;">
                    <label>Time Interval:
                        <select id="timeIntervalSelect">
                            <option value="day">Last Day</option>
                            <option value="week" selected>Last Week</option>
                            <option value="month">Last Month</option>
                            <option value="custom">Custom</option>
                        </select>
                    </label>
                    <div id="customDateInputs" style="display:none; margin-top:10px;">
                        <label>From: <input type="datetime-local" id="customFrom" /></label>
                        <label>To: <input type="datetime-local" id="customTo" /></label>
                        <button id="applyCustomRangeBtn" class="btn btn-primary"
                            style="margin-left:10px;">Apply</button>
                    </div>
                </div>

                <canvas id="patientTelemetryChart" style="max-width: 100%; height: 400px;"></canvas>
            </div>
        </div>

        <div class="patients-grid" id="patientsGrid">
            <!-- Patient cards will be dynamically generated -->
        </div>
    </div>

    <!-- Add Patient Button -->
    <div class="controls" style="justify-content: center;">
        <button class="btn btn-primary" id="openAddPatientBtn">➕ Add Patient</button>
    </div>

    <!-- Add Patient Modal -->
    <div id="addPatientModal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 20px; max-width: 420px; width: 100%; padding: 30px 35px; position: relative;
           box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
           border: 1px solid rgba(255, 255, 255, 0.15);
           font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
            <button id="closeAddPatientBtn" style="position: absolute; top: 15px; right: 20px; font-size: 28px; background: none; border: none; cursor: pointer; color: #764ba2;
             transition: color 0.3s ease;">&times;</button>
            <h2 style="color: #2c3e50; margin-bottom: 20px; font-weight: 700; text-align: center;">Add New Patient</h2>

            <form id="addPatientFormModal" style="display: flex; flex-direction: column; gap: 18px;">

                <input type="text" id="modal_name" placeholder="Full Name" required style="padding: 14px 18px; border: 1.8px solid #ddd; border-radius: 12px; font-size: 1em; color: #333;
             outline-offset: 3px; transition: border-color 0.3s ease;">
                <input type="text" id="modal_age" placeholder="Age" required min="0" style="padding: 14px 18px; border: 1.8px solid #ddd; border-radius: 12px; font-size: 1em; color: #333;
             outline-offset: 3px; transition: border-color 0.3s ease;">
                <select id="modal_gender" style="padding: 14px 18px; border: 1.8px solid #ddd; border-radius: 12px; font-size: 1em; color: #333;
              outline-offset: 3px; background: white; transition: border-color 0.3s ease;">
                    <option value="" disabled selected>Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>

                <button type="submit" class="btn btn-primary" style="padding: 15px; border-radius: 14px; font-weight: 700; font-size: 1.1em; background: linear-gradient(135deg, #667eea, #764ba2);
               color: white; border: none; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
               transition: transform 0.3s ease, box-shadow 0.3s ease;">
                    Add Patient
                </button>
            </form>
        </div>
    </div>

    <div class="controls" style="justify-content: center;">
        <button class="btn btn-primary" id="startMonitoringBtn">▶️ Start Monitoring</button>
        <button class="btn btn-secondary" id="pauseMonitoringBtn" disabled>⏸️ Pause Monitoring</button>
    </div>














    <script>


        document.getElementById('openAddPatientBtn').addEventListener('click', () => {
            document.getElementById('addPatientModal').style.display = 'flex';
        });

        document.getElementById('closeAddPatientBtn').addEventListener('click', () => {
            document.getElementById('addPatientModal').style.display = 'none';
        });

        // Handle add patient form submission inside modal
        // document.getElementById('addPatientFormModal').addEventListener('submit', async (e) => {
        //     e.preventDefault();

        //     const patient = {
        //         "name": document.getElementById('modal_name').value,
        //         "age": parseInt(document.getElementById('modal_age').value),
        //         "gender": document.getElementById('modal_gender').value
        //     };

        //     try {
        //         const response = await fetch("https://2bxm8pytc9.execute-api.eu-north-1.amazonaws.com/AddNewPatient", {
        //             method: "POST",
        //             headers: {
        //                 "Content-Type": "application/json"
        //             },
        //             body: JSON.stringify(patient)
        //         });

        //         const result = await response.json();
        //         alert(result.message || result.error);

        //         if (!result.error) {
        //             document.getElementById('addPatientModal').style.display = 'none';
        //             // Optionally clear the form fields here
        //             e.target.reset();
        //         }
        //     } catch (err) {
        //         alert('Failed to add patient: ' + err.message);
        //     }
        // });

        document.getElementById('addPatientFormModal').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('modal_name').value.trim();
            const age = parseInt(document.getElementById('modal_age').value);
            const gender = document.getElementById('modal_gender').value;

            if (!name || !age || !gender) {
                alert('Please fill all fields correctly.');
                return;
            }

            const patient = { name, age, gender };

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            try {
                const response = await fetch("https://2bxm8pytc9.execute-api.eu-north-1.amazonaws.com/AddNewPatient", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(patient)
                });

                const result = await response.json();
                alert(result.message || result.error || 'Patient added.');

                if (!result.error) {
                    document.getElementById('addPatientModal').style.display = 'none';
                    e.target.reset();
                }
            } catch (err) {
                alert('Failed to add patient: ' + err.message);
            } finally {
                submitBtn.disabled = false;
            }
        });











        let telemetryChart = null;
        let telemetryUpdateInterval = null;
        let currentPatientId = null;
        let currentTimeInterval = 'week'; // default
        let alertsInterval = null;
        let patientsInterval = null;
        let patients = [];


        // Attach event listeners

        document.getElementById('startMonitoringBtn').addEventListener('click', startMonitoring);
        document.getElementById('pauseMonitoringBtn').addEventListener('click', pauseMonitoring);
















        // Fetch alerts from the API   
        // setInterval(function () {
        //     fetch("https://va9vqf8y17.execute-api.eu-north-1.amazonaws.com/alerts")
        //         .then(res => res.json())
        //         .then(data => {
        //             const container = document.getElementById("alertsContainer");
        //             container.innerHTML = "";

        //             data.forEach(alert => {
        //                 let icon = "ℹ️", cssClass = "alert-info";
        //                 if (alert.severity === "high") {
        //                     icon = "💓";
        //                     cssClass = "alert-critical";
        //                 } else if (alert.severity === "medium") {
        //                     icon = "🫁";
        //                     cssClass = "alert-warning";
        //                 } else if (alert.severity === "low") {
        //                     icon = "🚶";
        //                     cssClass = "alert-info";
        //                 }

        //                 const div = document.createElement("div");
        //                 div.className = `alert-item ${cssClass}`;
        //                 div.innerHTML = `
        //             <div class="alert-icon">${icon}</div>
        //             <div class="alert-content">
        //             <div class="alert-title">${alert.severity.charAt(0).toUpperCase() + alert.severity.slice(1)}: ${alert.issue}</div>
        //             <div class="alert-time">Patient ${alert.patient}</div>
        //             </div>
        //         `;
        //                 container.appendChild(div);
        //             });
        //         })
        //         .catch(err => {
        //             console.error("Error fetching alerts:", err);
        //         });
        // }, 1000);



        // setInterval(function () {
        //     fetch('https://06d194icta.execute-api.eu-north-1.amazonaws.com/patients/status')
        //         .then(res => res.json())
        //         .then(data => {
        //             patients = data;
        //             generatePatientCards();
        //             updateStats();
        //         })
        //         .catch(err => console.error("API Error:", err));
        // }, 1000);


        function startMonitoring() {
            if (alertsInterval || patientsInterval) return; // already running

            alertsInterval = setInterval(() => {
                fetch("https://va9vqf8y17.execute-api.eu-north-1.amazonaws.com/alerts")
                    .then(res => res.json())
                    .then(data => {
                        const container = document.getElementById("alertsContainer");
                        container.innerHTML = "";

                        data.forEach(alert => {
                            let icon = "ℹ️", cssClass = "alert-info";
                            if (alert.severity === "high") {
                                icon = "💓";
                                cssClass = "alert-critical";
                            } else if (alert.severity === "medium") {
                                icon = "🫁";
                                cssClass = "alert-warning";
                            } else if (alert.severity === "low") {
                                icon = "🚶";
                                cssClass = "alert-info";
                            }

                            const div = document.createElement("div");
                            div.className = `alert-item ${cssClass}`;
                            div.innerHTML = `
                        <div class="alert-icon">${icon}</div>
                        <div class="alert-content">
                            <div class="alert-title">${alert.severity.charAt(0).toUpperCase() + alert.severity.slice(1)}: ${alert.issue}</div>
                            <div class="alert-time">Patient ${alert.patient}</div>
                        </div>
                    `;
                            container.appendChild(div);
                        });
                    })
                    .catch(err => {
                        console.error("Error fetching alerts:", err);
                    });
            }, 1000);

            patientsInterval = setInterval(() => {
                fetch('https://06d194icta.execute-api.eu-north-1.amazonaws.com/patients/status')
                    .then(res => res.json())
                    .then(data => {
                        patients = data;
                        generatePatientCards();
                        updateStats();
                    })
                    .catch(err => console.error("API Error:", err));
            }, 1000);

            // Enable/disable buttons accordingly:
            document.getElementById('startMonitoringBtn').disabled = true;
            document.getElementById('pauseMonitoringBtn').disabled = false;
        }

        function pauseMonitoring() {
            if (alertsInterval) {
                clearInterval(alertsInterval);
                alertsInterval = null;
            }
            if (patientsInterval) {
                clearInterval(patientsInterval);
                patientsInterval = null;
            }

            // Enable/disable buttons accordingly:
            document.getElementById('startMonitoringBtn').disabled = false;
            document.getElementById('pauseMonitoringBtn').disabled = true;
        }



        // document.getElementById("addPatientForm").addEventListener("submit", async function (e) {
        //     e.preventDefault();

        //     const patient = {
        //         patient_id: document.getElementById("patient_id").value,
        //         name: document.getElementById("name").value,
        //         age: parseInt(document.getElementById("age").value),
        //         gender: document.getElementById("gender").value
        //     };

        //     const response = await fetch("https://<your-api-gateway-url>/add-patient", {
        //         method: "POST",
        //         headers: {
        //             "Content-Type": "application/json"
        //         },
        //         body: JSON.stringify(patient)
        //     });

        //     const result = await response.json();
        //     alert(result.message || result.error);
        // });











        // Generate patient cards
        function generatePatientCards() {
            const container = document.getElementById('patientsGrid');
            container.innerHTML = '';

            patients.forEach(patient => {
                const statusClass = `status-${patient.status}`;
                const statusText = patient.status.charAt(0).toUpperCase() + patient.status.slice(1);

                const card = document.createElement('div');
                card.className = 'patient-card';
                card.innerHTML = `
                    <div class="patient-header">
                        <div class="patient-avatar">${patient.name.split(' ').map(n => n[0]).join('')}</div>
                        <div class="patient-info">
  <h3 class="patient-name-clickable" data-patient-id="${patient.patient_id}" style="cursor:pointer; color:#667eea; text-decoration: underline;">${patient.name}</h3>
</div>
                    </div>
                    <div class="vital-signs">
                        <div class="vital-item">
                            <div class="vital-value" style="color: #e74c3c">${patient.heartRate}</div>
                            <div class="vital-label">Heart Rate</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-value" style="color: #3498db">${patient.oxygenLevel}</div>
                            <div class="vital-label">O2 Saturation</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-value" style="color: #f39c12">${patient.status.charAt(0).toUpperCase() + patient.status.slice(1)}</div>
                            <div class="vital-label">Status</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-value" style="color: #27ae60">${patient.age}</div>
                            <div class="vital-label">Age</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            // Add click listeners for the patient names:
            document.querySelectorAll('.patient-name-clickable').forEach(el => {
                el.addEventListener('click', () => {
                    const patientId = el.getAttribute('data-patient-id');
                    const patientName = el.textContent;
                    openPatientModal(patientId, patientName);
                });
            });
        }



        function openPatientModal(patientId, patientName) {
            currentPatientId = patientId;

            document.getElementById('modalPatientName').textContent = patientName;
            document.getElementById('patientModal').style.display = 'flex';

            // Reset custom date inputs visibility
            document.getElementById('customDateInputs').style.display = 'none';
            document.getElementById('timeIntervalSelect').value = currentTimeInterval;

            // Initialize chart if not exists
            if (!telemetryChart) {
                const ctx = document.getElementById('patientTelemetryChart').getContext('2d');
                telemetryChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [], // timestamps
                        datasets: [
                            {
                                label: 'Heart Rate (BPM)',
                                data: [],
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.2)',
                                yAxisID: 'y1',
                                tension: 0.3,
                            },
                            {
                                label: 'O2 Saturation (%)',
                                data: [],
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                                yAxisID: 'y2',
                                tension: 0.3,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        stacked: false,
                        scales: {
                            y1: {
                                type: 'linear',
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Heart Rate (BPM)'
                                },
                                min: 40,
                                max: 200
                            },
                            y2: {
                                type: 'linear',
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'O2 Saturation (%)'
                                },
                                min: 70,
                                max: 100,
                                grid: {
                                    drawOnChartArea: false,
                                }
                            },
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'hour',
                                    tooltipFormat: 'MMM d, h:mm a'
                                },
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            }
                        }
                    }
                });
            }

            // Fetch initial telemetry and start update interval
            fetchAndUpdateTelemetry();

            if (telemetryUpdateInterval) clearInterval(telemetryUpdateInterval);
            telemetryUpdateInterval = setInterval(fetchAndUpdateTelemetry, 5000);  // update every 5 seconds
        }

        function fetchAndUpdateTelemetry() {
            if (!currentPatientId) return;

            // Calculate start and end times based on selected interval
            let endTime = new Date();
            let startTime = new Date();

            const timeInterval = document.getElementById('timeIntervalSelect').value;
            currentTimeInterval = timeInterval;

            if (timeInterval === 'day') {
                startTime.setDate(endTime.getDate() - 1);
            } else if (timeInterval === 'week') {
                startTime.setDate(endTime.getDate() - 7);
            } else if (timeInterval === 'month') {
                startTime.setMonth(endTime.getMonth() - 1);
            } else if (timeInterval === 'custom') {
                const fromInput = document.getElementById('customFrom').value;
                const toInput = document.getElementById('customTo').value;

                if (!fromInput || !toInput) {
                    // If missing custom dates, do not fetch
                    return;
                }

                startTime = new Date(fromInput);
                endTime = new Date(toInput);
            }

            // Convert dates to ISO strings
            const startISO = startTime.toISOString();
            const endISO = endTime.toISOString();

            const url = `https://wm5wmr6g25.execute-api.eu-north-1.amazonaws.com/GraphTelemetry?patientId=${encodeURIComponent(currentPatientId)}&start=${encodeURIComponent(startISO)}&end=${encodeURIComponent(endISO)}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    // Expected data format: array of { timestamp, heartRate, oxygenLevel }
                    updateTelemetryChart(data);
                })
                .catch(err => {
                    console.error("Error fetching telemetry data:", err);
                });
        }

        function updateTelemetryChart(data) {
            console.log('Telemetry data received:', data);

            if (!Array.isArray(data) || data.length === 0) {
                console.warn('No telemetry data available to plot');
                telemetryChart.data.labels = [];
                telemetryChart.data.datasets[0].data = [];
                telemetryChart.data.datasets[1].data = [];
                telemetryChart.update();
                return;
            }

            // Sort data by timestamp ascending
            data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            // Map for chart.js
            telemetryChart.data.labels = data.map(d => new Date(d.timestamp));
            telemetryChart.data.datasets[0].data = data.map(d => d.heartRate);
            telemetryChart.data.datasets[1].data = data.map(d => d.oxygenLevel);

            telemetryChart.update();
        }

        document.getElementById('timeIntervalSelect').addEventListener('change', (e) => {
            const value = e.target.value;
            const customDateInputs = document.getElementById('customDateInputs');
            if (value === 'custom') {
                customDateInputs.style.display = 'block';
            } else {
                customDateInputs.style.display = 'none';
                fetchAndUpdateTelemetry();  // auto refresh for new range
            }
        });

        document.getElementById('applyCustomRangeBtn').addEventListener('click', () => {
            fetchAndUpdateTelemetry();
        });




        // Update warnings display
        function updateWarnings() {
            const criticalCount = patients.filter(p => p.status === 'critical').length;
            const warningCount = patients.filter(p => p.status === 'warning').length;
            const routineCount = Math.floor(Math.random() * 15) + 5;

            const warningsContainer = document.getElementById('warningsContainer');
            warningsContainer.innerHTML = `
                <div class="warning-item high-priority">
                    <div class="warning-icon">🚨</div>
                    <div class="warning-content">
                        <div class="warning-title">High Priority</div>
                        <div class="warning-desc">${criticalCount} patients require immediate attention</div>
                        <div class="warning-actions">
                            <button class="btn-small btn-danger" onclick="viewCriticalPatients()">View Details</button>
                        </div>
                    </div>
                </div>
                <div class="warning-item medium-priority">
                    <div class="warning-icon">⚠️</div>
                    <div class="warning-content">
                        <div class="warning-title">Medium Priority</div>
                        <div class="warning-desc">${warningCount} patients showing warning signs</div>
                        <div class="warning-actions">
                            <button class="btn-small btn-warning" onclick="reviewWarnings()">Review</button>
                        </div>
                    </div>
                </div>
                <div class="warning-item low-priority">
                    <div class="warning-icon">ℹ️</div>
                    <div class="warning-content">
                        <div class="warning-title">Low Priority</div>
                        <div class="warning-desc">${routineCount} routine notifications pending</div>
                        <div class="warning-actions">
                            <button class="btn-small btn-info" onclick="checkRoutine()">Check Later</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update statistics
        function updateStats() {
            const criticalCount = patients.filter(p => p.status === 'critical').length;
            const warningCount = patients.filter(p => p.status === 'warning').length;
            const dataPoints = patients.length * 3600; // Assuming 60 data points per patient per hour

            console.log(patients.length + " patients");
            document.getElementById('activePatients').textContent = patients.length;
            document.getElementById('dataPoints').textContent = dataPoints.toLocaleString();
        }


        document.getElementById('closeModalBtn').addEventListener('click', () => {
            console.log("Close button clicked")
            document.getElementById('patientModal').style.display = 'none';
            if (telemetryUpdateInterval) {
                clearInterval(telemetryUpdateInterval);
                telemetryUpdateInterval = null;
            }
            telemetryChart?.data.labels && telemetryChart.data.labels.splice(0);
            telemetryChart?.update();
        });


    </script>
</body>

</html>